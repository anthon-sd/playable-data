---
import Layout from '../../layouts/Layout.astro';
import { getArticles } from '../../utils/supabase';

// Get case studies from database (filtered by tag or category)
let allCaseStudies = [];
try {
  const articles = await getArticles();
  allCaseStudies = articles.filter(article => 
    article.tags && article.tags.includes('case-study')
  );
} catch (error) {
  console.error('Error loading case studies:', error);
}

const sortedCaseStudies = allCaseStudies.sort((a, b) => 
  new Date(b.created_at).valueOf() - new Date(a.created_at).valueOf()
);

// Get unique industries (using tags as proxy)
const allIndustries = [...new Set(allCaseStudies.flatMap(study => 
  study.tags?.filter(tag => tag !== 'case-study') || []
))].sort();
---

<Layout title="Case Studies - Playable Data">
  <div class="bg-gradient-to-r from-primary-700 to-primary-900 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20">
      <h1 class="text-4xl md:text-5xl font-bold">Case Studies</h1>
      <p class="mt-4 text-xl text-primary-100 max-w-3xl">
        Real-world examples of how we've helped businesses solve complex technology challenges
      </p>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="flex flex-col md:flex-row gap-8">
      <!-- Main content -->
      <div class="md:w-3/4">
        {sortedCaseStudies.length > 0 ? (
          <div class="grid grid-cols-1 gap-8">
            {sortedCaseStudies.map(study => (
              <article class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-lg transition flex flex-col md:flex-row">
                {study.cover_image && (
                  <div class="md:w-1/3">
                    <img 
                      src={study.cover_image} 
                      alt={study.title} 
                      class="w-full h-full object-cover"
                    />
                  </div>
                )}
                <div class="p-6 md:w-2/3">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-sm bg-primary-100 text-primary-800 px-3 py-1 rounded-full">
                      {study.tags?.find(tag => tag !== 'case-study') || 'Technology'}
                    </span>
                    <span class="text-sm text-gray-500">
                      {study.client || 'Client'}
                    </span>
                  </div>
                  <h2 class="text-2xl font-bold text-gray-900 mb-3">
                    <a href={`/blog/${study.slug}`} class="hover:text-primary-700 transition">
                      {study.title}
                    </a>
                  </h2>
                  <p class="text-gray-600 mb-4">{study.description}</p>
                  <div class="flex flex-wrap gap-2 mb-4">
                    {study.tags?.filter(tag => tag !== 'case-study').map(tech => (
                      <span class="bg-gray-100 text-gray-700 text-sm px-3 py-1 rounded-full">
                        {tech}
                      </span>
                    ))}
                  </div>
                  <a href={`/blog/${study.slug}`} class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium">
                    Read Case Study
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </a>
                </div>
              </article>
            ))}
          </div>
        ) : (
          <div class="bg-white rounded-lg p-8 shadow-md text-center">
            <p class="text-gray-600">Case studies coming soon!</p>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="md:w-1/4">
        <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Industries</h2>
          {allIndustries.length > 0 ? (
            <div class="space-y-2">
              {allIndustries.map(industry => (
                <a href={`/tags/${industry}`} class="block text-gray-700 hover:text-primary-700 transition">
                  {industry}
                </a>
              ))}
            </div>
          ) : (
            <p class="text-gray-600">Industries coming soon</p>
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>